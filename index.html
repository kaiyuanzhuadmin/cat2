<!DOCTYPE html>
<html lang="zh-CN">
<head>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
 <title>çŒ«äº†ä¸ªçŒ« - ç½‘é¡µå°æ¸¸æˆ</title>
 <style>
   body {
     margin: 0;
     font-family: 'Segoe UI', 'PingFang SC', 'Helvetica Neue', Arial, 'Microsoft Yahei', sans-serif;
     background: #b6e388 url('https://img.zcool.cn/community/01e3f05c2c1e7ea801214168e1e7e2.jpg') no-repeat center center fixed;
     background-size: cover;
     min-height: 100vh;
     overflow-x: hidden;
     color: #333;
   }
   #game-container {
     max-width: 480px;
     margin: 24px auto 0 auto;
     background: rgba(255,255,255,0.92);
     border-radius: 18px;
     box-shadow: 0 2px 16px #7db36a60;
     padding: 0 0 24px 0;
     position: relative;
     min-height: 700px;
     display: flex;
     flex-direction: column;
     align-items: center;
   }
   @media (max-width: 540px) {
     #game-container { max-width: 100vw; box-shadow: none; border-radius: 0; min-height: 95vh;}
   }
   #header-bar {
     width: 100%;
     padding: 12px 20px 0 20px;
     box-sizing: border-box;
     display: flex;
     justify-content: space-between;
     align-items: center;
   }
   #progress-info {
     font-size: 1rem;
     font-weight: bold;
   }
   #music-toggle {
     background: none;
     border: none;
     outline: none;
     font-size: 1.6rem;
     cursor: pointer;
   }
   #main-area {
     flex:1;
     width: 100%;
     display: flex;
     flex-direction: column;
     align-items: center;
     justify-content: flex-start;
   }
   #card-stack-area {
     margin-top: 10px;
     width: 400px; /* Increased width */
     height: 300px; /* Increased height */
     position: relative;
     background: rgba(255,255,255,0.10);
     border-radius: 10px;
     box-shadow: 0 2px 6px #d8ecd8cc;
     overflow: visible;
     display: flex;
     align-items: center;
     justify-content: center;
   }
   @media (max-width: 400px) {
     #card-stack-area {
       width: 96vw; /* Adjusted for mobile */
       min-width: 220px;
       height: 280px; /* Adjusted for mobile */
     }
   }
   /* Default card size */
   .card {
     width: 60px; /* Adjusted card width */
     height: 80px; /* Adjusted card height */
     background: #fff;
     border-radius: 8px;
     box-shadow: 0 2px 10px #c2d6b3b0, 2px 4px 16px #aaa4;
     border: 2px solid #b6e388;
     position: absolute;
     display: flex;
     align-items: center;
     justify-content: center;
     font-size: 2.4rem; /* Slightly larger icon */
     cursor: pointer;
     user-select: none;
     transition: transform 0.06s, box-shadow 0.09s, opacity 0.15s; /* SPEED UP */
     z-index: 1;
     overflow: hidden;
   }
   .card.selected {
     border: 2.5px solid #558c25;
     box-shadow: 0 2px 18px #b6e388;
     z-index: 100 !important;
     transform: scale(1.08) rotate(-3deg);
   }
   .card.disabled {
     opacity: 0.42;
     pointer-events: none;
   }
   .card.matched {
     opacity: 0.1;
     transition: opacity 0.15s; /* SPEED UP */
     pointer-events: none;
   }
   .card .mini {
     font-size: 1.1rem;
     position: absolute;
     bottom: 6px;
     right: 8px;
     opacity: 0.45;
   }
   #temp-area {
     margin: 14px auto 0 auto;
     display: flex;
     justify-content: center;
     align-items: center;
     min-height: 68px;
     width: 380px; /* Adjusted width to fit 7 slots + margins */
     border-radius: 8px;
     background: #f7f7f7;
     border: 1.5px dashed #b6e388;
     padding: 7px 0;
     box-sizing: border-box;
   }
   .temp-slot { /* New style for the temporary slot placeholders */
     width: 50px;
     height: 65px;
     margin: 0 4px; /* Adjusted margin */
     background: #e0e0e0; /* A slightly darker background for empty slots */
     border-radius: 7px;
     border: 2px dashed #a0a0a0; /* Distinct dashed border for empty slots */
     display: flex;
     align-items: center;
     justify-content: center;
     font-size: 1.8rem;
     color: #777; /* Text color for empty slots if needed, not used for icons */
     box-shadow: 0 1px 3px rgba(0,0,0,0.1);
     position: relative;
     overflow: hidden; /* Ensure card content stays within bounds */
   }
   .temp-card { /* Style for cards placed in temp slots */
     width: 100%;
     height: 100%;
     background: #fff;
     border-radius: 7px;
     border: 2px solid #c5e6b3; /* Solid border for active cards */
     display: flex;
     align-items: center;
     justify-content: center;
     font-size: 1.8rem;
     box-shadow: 0 2px 6px #b6e38880;
     cursor: default;
     position: absolute; /* Position within the slot */
     transition: opacity 0.12s; /* SPEED UP */
     box-sizing: border-box; /* Include padding and border in the element's total width and height */
   }
   .temp-card.matched {
     opacity: 0.1;
   }
   /* --- New style for the animated "flying" card --- */
   .flying-card {
     width: 60px;
     height: 80px;
     background: #fff;
     border-radius: 8px;
     box-shadow: 0 2px 10px #c2d6b3b0, 2px 4px 16px #aaa4;
     border: 2px solid #b6e388;
     position: fixed; /* Use fixed positioning for viewport-relative animation */
     display: flex;
     align-items: center;
     justify-content: center;
     font-size: 2.4rem;
     user-select: none;
     z-index: 999; /* Ensure it's on top of everything */
     transition: top 0.2s ease-in-out, left 0.2s ease-in-out, transform 0.2s ease-in-out; /* FASTER DROP */
     overflow: hidden;
   }
   #tools-bar {
     margin: 14px auto 0 auto;
     display: flex;
     align-items: center;
     justify-content: center;
     gap: 16px;
     width: 380px; /* Adjusted to accommodate the new button */
     flex-wrap: wrap; /* Allow buttons to wrap on smaller screens */
   }
   #tools-bar button {
     padding: 7px 15px;
     background: #e6f6d3;
     border: 1.5px solid #b6e388;
     border-radius: 7px;
     font-size: 1rem;
     color: #335c1d;
     font-weight: bold;
     cursor: pointer;
     transition: background 0.10s; /* SPEED UP */
     outline: none;
     position: relative;
     min-width: 68px;
   }
   #tools-bar button:disabled {
     background: #f0f0f0;
     color: #b0b0b0;
     border-color: #d0d0d0;
     cursor: not-allowed;
   }
   #restart-btn { /* Style for the new restart button */
     background: #ffe0b3;
     border-color: #ffcc80;
     color: #96602c;
   }
   #restart-btn:hover {
     background: #ffd599;
   }
   #code-bar {
     margin: 10px auto 0 auto;
     display: flex;
     align-items: center;
     justify-content: center;
     gap: 6px;
     width: 340px;
   }
   #code-bar input {
     width: 110px;
     padding: 5px 8px;
     border-radius: 6px;
     border: 1.5px solid #b6e388;
     outline: none;
     font-size: 1rem;
     margin-right: 3px;
   }
   #code-bar button {
     padding: 5px 8px;
     font-size: 1rem;
     background: #e6f6d3;
     border: 1.5px solid #b6e388;
     border-radius: 7px;
     cursor: pointer;
     color: #335c1d;
     font-weight: bold;
     transition: background 0.10s; /* SPEED UP */
     min-width: 56px;
   }
   #message-bar {
     margin: 10px auto 0 auto;
     text-align: center;
     font-size: 1.02rem;
     color: #e65c4f;
     min-height: 24px;
     font-weight: bold;
     letter-spacing: 1px;
   }
   #start-screen, #level-finish, #game-over {
     position: absolute;
     left: 0; right: 0; top: 0; bottom: 0;
     z-index: 88;
     background: rgba(255,255,255,0.92);
     display: flex;
     align-items: center;
     justify-content: center;
     flex-direction: column;
     font-size: 1.2rem;
     border-radius: 18px;
     text-align: center;
   }
   #start-screen h1 {
     font-size: 2.3rem;
     margin: 0 0 18px 0;
     color: #6e352f;
     font-family: 'Comic Sans MS', 'Segoe Print', cursive;
     letter-spacing: 2px;
     text-shadow: 1px 1px 0 #c5e6b3, 2px 2px 0 #b6e388;
   }
   #start-screen .start-btn {
     margin-top: 20px;
     padding: 12px 42px;
     font-size: 1.3rem;
     background: linear-gradient(90deg,#b6e388,#c5e6b3);
     border: none;
     border-radius: 11px;
     color: #335c1d;
     font-weight: bold;
     cursor: pointer;
     box-shadow: 0 2px 8px #b6e388;
     transition: background 0.12s; /* SPEED UP */
   }
   #start-screen .start-btn:hover {
     background: linear-gradient(90deg,#c5e6b3,#b6e388);
   }
   #level-finish, #game-over {
     font-size: 1.7rem;
     color: #335c1d;
     background: rgba(255,255,255,0.97);
     border-radius: 18px;
   }
   #level-finish button, #game-over button {
     margin-top: 22px;
     padding: 10px 28px;
     font-size: 1.12rem;
     background: #e6f6d3;
     border: 1.5px solid #b6e388;
     border-radius: 9px;
     color: #335c1d;
     font-weight: bold;
     cursor: pointer;
     transition: background 0.10s; /* SPEED UP */
   }
   #level-finish button:hover, #game-over button:hover {
     background: #d2e5bb;
   }
   #retry-btn {
     margin-top: 14px;
     padding: 9px 24px;
     font-size: 1.08rem;
     background: #f5eac6;
     border: 1.5px solid #e5d88a;
     border-radius: 7px;
     color: #6e352f;
     font-weight: bold;
     cursor: pointer;
     transition: background 0.10s; /* SPEED UP */
     display: inline-block;
   }
   #retry-btn:hover {
     background: #f7f4de;
   }
   #footer {
     margin: 16px auto 0 auto;
     width: 100%;
     text-align: center;
     font-size: 0.98rem;
     color: #558c25;
     font-family: 'Comic Sans MS', 'Segoe Print', cursive;
     letter-spacing: 1.4px;
   }

   /* --- Styles for Level 2 on ALL devices to reduce difficulty --- */
   body.level-2-active .card {
     width: 45px; /* Smaller card width for Level 2 */
     height: 60px; /* Smaller card height for Level 2 */
     font-size: 1.8rem; /* Adjusted font size for smaller cards */
     border-width: 1.5px; /* Slightly thinner border for smaller cards */
     transition: transform 0.05s, box-shadow 0.07s, opacity 0.12s; /* SPEED UP LV2 */
   }
   body.level-2-active .flying-card {
     width: 45px;
     height: 60px;
     font-size: 1.8rem;
     border-width: 1.5px;
     transition: top 0.15s ease-in-out, left 0.15s ease-in-out, transform 0.15s ease-in-out; /* FASTER DROP LV2 */
   }
   body.level-2-active .temp-slot {
     width: 40px; /* Smaller temp slot to fit smaller cards */
     height: 55px; /* Smaller temp slot height */
     margin: 0 3px; /* Reduced margin between temp slots */
     border-width: 1.5px;
   }
   body.level-2-active .temp-card {
     font-size: 1.5rem; /* Adjusted font size for smaller temp cards */
     border-width: 1.5px;
     transition: opacity 0.10s; /* SPEED UP LV2 */
   }
   body.level-2-active #temp-area {
     width: 330px;
     min-height: 55px; /* Adjust min-height to fit smaller temp slots */
     padding: 5px 0; /* Slightly reduced padding */
   }
   body.level-2-active #card-stack-area {
     height: 260px; /* Slightly reduced height for stack area to match smaller cards */
   }
   /* --- End new styles --- */

   @media (max-width: 420px) {
     #card-stack-area, #temp-area, #tools-bar, #code-bar { width: 98vw;}
     #tools-bar button {
         min-width: unset; /* Remove min-width constraint */
         width: 30%; /* Distribute evenly */
         margin-bottom: 8px; /* Add some spacing when wrapped */
     }
     #tools-bar {
         gap: 8px; /* Reduce gap when wrapped */
     }
   }
 </style>
</head>
<body>
<div id="game-container">
 <div id="header-bar">
   <div id="progress-info">å…³å¡: 1 / 2 | å‰©ä½™å¡ç‰Œ: --</div>
   <button id="music-toggle" title="éŸ³ä¹å¼€å…³">ğŸµ</button>
 </div>
 <div id="main-area">
   <div id="card-stack-area"></div>
   <div id="temp-area">
     <div class="temp-slot"></div>
     <div class="temp-slot"></div>
     <div class="temp-slot"></div>
     <div class="temp-slot"></div>
     <div class="temp-slot"></div>
     <div class="temp-slot"></div>
     <div class="temp-slot"></div>
   </div>
   <div id="tools-bar">
     <button id="undo-btn" disabled title="æ’¤é”€(éœ€å…‘æ¢ç )">â†©ï¸ æ’¤é”€ (<span id="undo-count">0</span>)</button>
     <button id="hint-btn" disabled title="æç¤º(éœ€å…‘æ¢ç )">ğŸ’¡ æç¤º (<span id="hint-count">0</span>)</button>
     <button id="shuffle-btn" disabled title="æ´—ç‰Œ(éœ€å…‘æ¢ç )">ğŸ”€ æ´—ç‰Œ (<span id="shuffle-count">0</span>)</button>
     <button id="restart-btn" title="é‡æ–°å¼€å§‹å½“å‰å…³å¡">ğŸ”„ é‡æ–°å¼€å§‹</button>
   </div>
   <div id="code-bar">
     <input type="text" id="code-input" placeholder="å…‘æ¢ç " maxlength="12">
     <button id="code-btn">å…‘æ¢</button>
   </div>
   <div id="message-bar"></div>
 </div>
 <div id="start-screen">
   <h1>çŒ«äº†ä¸ªçŒ« ğŸ¾</h1>
   <div style="font-size:1.12rem;color:#335c1d;margin-bottom:10px;">
     ç©æ³•ï¼šç‚¹å‡»å¡ç‰Œè¿›è¡Œæ”¶é›†ï¼Œ3å¼ ç›¸åŒè‡ªåŠ¨æ¶ˆé™¤ï¼Œå…¨éƒ¨æ¸…ç©ºè¿‡å…³ï¼Œæš‚å­˜åŒºåªèƒ½æ”¾7å¼ ï¼Œè¶…é™å¤±è´¥ã€‚<br>
     <span style="color:#f26b4b;">ç¬¬äºŒå…³éš¾åº¦é£™å‡</span>ï¼Œæ”¯æŒä½¿ç”¨å…‘æ¢ç è§£é”é“å…·ã€‚<br>
     <span style="font-size:0.95rem;color:#666;">çŒ«äº†ä¸ªçŒ« &copy; 2025 | Designed by å¼€å…ƒ</span>
   </div>
   <button class="start-btn" id="start-btn">å¼€å§‹æ¸¸æˆ</button>
 </div>
 <div id="level-finish" style="display:none;">
   <div id="level-finish-text"></div>
   <button id="next-btn">ä¸‹ä¸€å…³</button>
   <button id="retry-btn" style="margin-left:10px;">é‡ç©</button>
 </div>
 <div id="game-over" style="display:none;">
   <div id="game-over-text"></div>
   <button id="retry-btn2">é‡è¯•</button>
 </div>
 <div id="footer">
   çŒ«äº†ä¸ªçŒ« &copy; 2025 | Designed by å¼€å…ƒ
 </div>
</div>
<audio id="bgm" src="PVZ.mp3" loop preload="auto"></audio>
<audio id="click-sound" src="PVZ.mp3" preload="auto"></audio>

<script>
const CARD_ICONS = [
 "ğŸ±", "ğŸ¶", "ğŸ»", "ğŸ¼", "ğŸ¦Š", "ğŸµ", "ğŸ¦", "ğŸ¸", "ğŸ§", "ğŸ¨",
 "ğŸ‰", "ğŸ“", "ğŸ‡", "ğŸŠ", "ğŸ", "ğŸ’", "ğŸ‹", "ğŸ¥"
];
const LEVELS = [
 {num: 1, visible: 18, total: 21, stack: 1, rows: 3, cols: 6, overlap: 30},
 {num: 2, visible: 90, total: 150, stack: 2, rows: 7, cols: 9, overlap: 22}
];
const TEMP_LIMIT = 7;
const CODE = "kaiyuan";
const TOOL_GRANT_COUNT = 3;

// --- Get Audio elements once ---
const bgm = document.getElementById('bgm');
const clickSound = document.getElementById('click-sound');

let game = {
 level: 1,
 cards: [],
 board: [],
 temp: [],
 matched: [],
 usedIcons: [],
 toolUses: {undo: 0, hint: 0, shuffle: 0},
 progress: 0,
 stepStack: [],
 bgmOn: true,
 lock: false
};

function randArr(arr) {
 return arr.slice().sort(()=>Math.random()-0.5);
}
function shuffle(arr) {
 for(let i=arr.length-1;i>0;i--){
   const j = Math.floor(Math.random()*(i+1));
